# QR角印システムのインストール方法



## 必要なもの

- Linux OS

- node



## インストール手順

### 1. プロジェクトフォルダをクローンする

```
$ git clone https://github.com/kunikazuokada/qrstamp
```

で、qrstampフォルダが作成され、リポジトリからプロジェクトフォルダの内容がコピーされます



### 2. 依存モジュールをインストールする

qrstampフォルダで、npm install を行います

```
$ npm install
```

依存モジュールのダウンロード、インストールが行われます

※ canvas モジュールのインストールに失敗することがあるかもしれません。がんばって何とかしましょう。



### 3. カスタマイズする

#### configパラメータを設定

qrstampフォルダの package.jsonファイルを編集し、config パラメータの組織名・代表者名などを書き換えてください

#### 角印イメージを置き換え

qrstampフォルダの**template**サブフォルダ にある、template.png が生成される角印のもとになる画像です。これを、利用する組織に合わせて作成した画像で置き換えてください。



### 4. テスト実行する

```
$ npm start
```

とすると、TCP/3000番ポートで稼働するWebサーバが起動します

http://hostname:3000/  (hostname部分は適宜置き換えて) にブラウザからアクセスすれば、QR角印システムのサンプル環境にアクセスできます



## 生成されるデータ

qrstampフォルダの下記のサブフォルダに、ファイルが生成されます

- `static/admin/qrStampImage`フォルダのサブフォルダに、生成された印影画像が、下記のようなパス名でPNGファイルとして保存されます

  ```
  static/admin/qrstampImage/2020/0415/161731.OxsBDjBWTKOgUikUsQ7ZsQ.png
  ```

- `static/qrstamp`フォルダのサブフォルダに、生成された捺印情報ぺージがHTMLファイルとして、下記のようなパス名で保存されます

  ```
  static/qrstamp/2020/0415/161731.OxsBDjBWTKOgUikUsQ7ZsQ.html
  ```

- ディスクあふれを起こさずに運用を継続するために、十分なディスク空き容量を確保したり、例えば、10年以上経過したデータは削除するなど、一定の周期で生成済ファイルを削除するようにしてください



## 本番運用に向けて

本番運用に際しては、下記のような注意が必要です

### 本番環境での要件

#### 印影生成画面は非公開にし、認証を要求する

- 印影の生成は、限られた権限者にのみ許可されるべき操作であるため、角印生成画面 ( /admin/newStamp.html )へのアクセスは非公開にせねばなりません
- 生成画面へのアクセスは、パスワード認証や証明書認証など、何等かの認証を経たユーザにのみ公開されるべきです

#### 生成済の捺印情報ページは、公開する

- 生成さえた捺印情報ページは、QRコードをスキャンするユーザの誰にでもアクセスできるよう、インターネットに公開します



### 本番環境構成のヒント

本番環境では、本システム（QR角印生成システム）を直接外部に公開せず、プロキシサーバを前段に用意して、一部ページのみを公開するようにしてください。

#### 構成例

- DNSサーバにエントリを編集して、https://qrstamp.会社名ドメイン/ で、HTTPSアクセスがホストに届くようにします

- nginx をインストールし、リバースプロキシサーバとしてセットアップします

  - SSL証明書をインストールして、HTTPSでのアクセスをサポートします

  - /qrstamp フォルダ以下のアクセスを、プロジェクトのstatic/qrstamp フォルダ以下につなぐようにして、生成済捺印情報を公開します

  - /admin フォルダ以下のアクセスは、原則非公開とします

    - 一定の条件でアクセスを許可するように、認証機能を構成します

      （方法はいろいろあるでしょうが、本文書の範囲外です）

- ファイヤウォールで3000番ポートを閉じて、本システムへの直接アクセスを禁止する

  - 必ずプロキシを通じてアクセスしなければいけないものとします



### 本番環境構成が面倒ですか？

はい。確かに、すこしばかり面倒です。

- 組織としてドメインの所有権を持ち、DNSサーバの管理ができる必要があります
- Linuxサーバ＋node Webアプリの構築・運用管理ができなければなりません
- リバースプロキシ、認証プロキシの構築ができなければなりません



QR角印システムの構築がこれだけ面倒であるということは、QR角印を不正利用・偽造しようとするのも同様に面倒でコストがかかるということであり、不正利用が簡単ではないという裏付けになる側面もあるのです。

